## 分析包体积

<script setup>
  import img from "/imgs/React项目/包分析结果.png"
  import img1 from "/imgs/React项目/路由懒加载后包分析.png"
  import img2 from "/imgs/React项目/分包后包分析.png"
  import img3 from "/imgs/React项目/css拆分.png"
</script>

首先安装包体积分析工具：

```sh
npm install --save source-map-explorer
```

然后在package.json中添加scripts：

```diff
"scripts": {
+    "analyze": "source-map-explorer 'build/static/js/*.js'",
    "start": "craco start",
    "build": "craco build",
    "test": "craco test",
    "eject": "react-scripts eject",
    "prepare": "husky install"
  },
```

先构建，再执行analyze：

```sh
npm run build
npm run analyze
```

分析结果如下：

<img :src="img"/>

可以看到main.js有1.64mb这么大，经过g-zip压缩也有500kb左右。体积太大需要分包。

## 1、配置路由懒加载

在router配置文件中，把大的路由组件配置懒加载：

```diff
+ import { lazy } from "react"
- // import Edit from "../pages/Question/Edit"
- // import Stat from "../pages/Question/Stat"

// 加上魔法注释区分文件名字
+ const Edit = lazy(() => import(/* webpackChunkName: "editPage" */ "../pages/Question/Edit"))
+ const Stat = lazy(() => import(/* webpackChunkName: "statPage" */ "../pages/Question/Stat"))
```

然后再进行包分析，可以看到min.js文件减小到1.19mb了。优化了0.45mb。

<img :src="img1"/>

但是还是太大了，我们继续优化。

## 2、抽离第三方代码

我们分析包发现antd和react-dom占用体积很大，由于项目antd等第三方库版本并不会轻易产生改变（更换版本，比如升级）。所以对于antd等第三方库，我们可以拆分出来，使用缓存机制。

要拆分包，我们需要了解webpack配置，我们使用[optimization.splitChunks](https://webpack.docschina.org/configuration/optimization/#optimizationsplitchunks)进行包的拆分。我们在craco.config.js中加入配置：

```diff
const path = require('path')
const sassResourcesLoader = require('craco-sass-resources-loader');

module.exports = {
  webpack: {
    alias: {
      "@": path.resolve(__dirname, "./src/")
    },
+    configure(webpackConfig) {
+      if (webpackConfig.mode === "production") {
+        // 只在生产环境下才进行拆分
+        if (webpackConfig.optimization == null) {
+          webpackConfig.optimization = {}
+        }
+        webpackConfig.optimization.splitChunks = {
+          chunks: "all",
+          cacheGroups: {
+            antd: {
+              name: "antd-chunk",
+              test: /antd/,
+              priority: 100 // 权限， 优先级
+            },
+            reactDom: {
+              name: "reactDom-chunk",
+              test: /react-dom/,
+              priority: 99 // 权限， 优先级
+            },
+            venders: {
+              name: "venders-chunk",
+              test: /node_modules/,
+              priority: 98 // 权限， 优先级
+            }
+          }
+        }
+      }
+
+      return webpackConfig
+    }
+  },
  plugins: [
    {
      plugin: sassResourcesLoader,
      options: {
        resources: "./src/global.scss"
      }
    }
  ],
  // 解决跨域
  devServer: {
    port: 8000,
    proxy: {
      "/api": "http://localhost:3001"
    }
  }
}
```

我们进行包分析：

<img :src="img2"/>

我们发现main.js减小到了35.9kb，其他包的大小如下：

| 包名           | 大小   |
| -------------- | ------ |
| node_modules   | 1.06MB |
| antd-chunk     | 484KB  |
| reactDom-chunk | 127KB  |

## 3、CSS拆分

css的拆分react-create-app已经帮我们做了，可以看到他的拆分规则是按我们的路由懒加载的配置来的：

<img :src="img3"/>